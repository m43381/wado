{% extends "base_account.html" %}
{% load static %}
{% load dict_filters %}

{% block title %}–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/research.css' %}">
<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º MathJax –¥–ª—è —Ñ–æ—Ä–º—É–ª -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
{% endblock %}

{% block account_content %}
<div class="research-container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="research-header">
        <h1>üéØ –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞—Ä—è–¥–æ–≤</h1>
        <p class="research-subtitle">–ê–Ω–∞–ª–∏–∑ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –º–µ—Ç–æ–¥–æ–≤ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</p>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å –±—ã—Å—Ç—Ä–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ -->
    <div class="research-quick-panel">
        <h2><i class="fas fa-rocket"></i> –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞</h2>
        
        <div class="quick-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="planSelect">
                        <i class="fas fa-calendar-alt"></i> –í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞–Ω:
                    </label>
                    <select id="planSelect" class="form-control">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞–Ω --</option>
                        {% for plan in monthly_plans %}
                        <option value="{{ plan.id }}" 
                                data-month="{{ plan.month|date:'F Y' }}"
                                data-duties="{{ plan.duties.count }}">
                            {{ plan.month|date:"F Y" }} ({{ plan.duties.count }} –Ω–∞—Ä—è–¥–æ–≤)
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="scenarioSelect">
                        <i class="fas fa-cogs"></i> –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ü–µ–Ω–∞—Ä–∏–π:
                    </label>
                    <select id="scenarioSelect" class="form-control">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ü–µ–Ω–∞—Ä–∏–π --</option>
                        {% for scenario in scenarios %}
                        <option value="{{ scenario.id }}">
                            {{ scenario.name }} (N1={{ scenario.n1_scenarios }}, N2={{ scenario.n2_runs }})
                        </option>
                        {% endfor %}
                    </select>
                    <small class="form-text">
                        <a href="#" id="createNewScenario">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π</a>
                    </small>
                </div>
            </div>
            
            <div class="quick-actions">
                <button id="runAnalysisBtn" class="btn btn-success" disabled>
                    <i class="fas fa-play"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                </button>
                <div class="quick-info">
                    <p><i class="fas fa-info-circle"></i> –ë—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –¥–≤—É—Ö–∫–æ–Ω—Ç—É—Ä–Ω—ã–π –°–ò–ú –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ V1 –∏ V2</p>
                </div>
            </div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="research-stats">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">{{ total_reports }}</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –æ—Ç—á—ë—Ç–æ–≤</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-calculator"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">{{ total_simulations|intcomma }}</div>
                    <div class="stat-label">–í—Å–µ–≥–æ —Å–∏–º—É–ª—è—Ü–∏–π</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">{{ monthly_plans|length }}</div>
                    <div class="stat-label">–î–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-scroll"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">{{ scenarios|length }}</div>
                    <div class="stat-label">–°—Ü–µ–Ω–∞—Ä–∏–µ–≤</div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ù–µ–¥–∞–≤–Ω–∏–µ –æ—Ç—á—ë—Ç—ã -->
    <div class="recent-reports-section">
        <h2><i class="fas fa-history"></i> –ù–µ–¥–∞–≤–Ω–∏–µ –æ—Ç—á—ë—Ç—ã</h2>
        
        {% if recent_reports %}
        <div class="reports-table">
            <table>
                <thead>
                    <tr>
                        <th>–ü–ª–∞–Ω</th>
                        <th>–°—Ü–µ–Ω–∞—Ä–∏–π</th>
                        <th>PÃÑ–¥—Ü V1</th>
                        <th>PÃÑ–¥—Ü V2</th>
                        <th>–õ—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç</th>
                        <th>–î–∞—Ç–∞</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for report in recent_reports %}
                    <tr>
                        <td>{{ report.plan.month|date:"F Y" }}</td>
                        <td>{{ report.scenario.name }}</td>
                        <td>
                            <span class="probability-badge {% if report.p_dc_v1_mean >= 0.8 %}good{% elif report.p_dc_v1_mean >= 0.6 %}medium{% else %}poor{% endif %}">
                                {{ report.p_dc_v1_mean|floatformat:3 }}
                            </span>
                        </td>
                        <td>
                            <span class="probability-badge {% if report.p_dc_v2_mean >= 0.8 %}good{% elif report.p_dc_v2_mean >= 0.6 %}medium{% else %}poor{% endif %}">
                                {{ report.p_dc_v2_mean|floatformat:3 }}
                            </span>
                        </td>
                        <td>
                            {% if report.get_better_variant == 'V1' %}
                            <span class="variant-badge v1">V1 (–∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)</span>
                            {% elif report.get_better_variant == 'V2' %}
                            <span class="variant-badge v2">V2 (–¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)</span>
                            {% else %}
                            <span class="variant-badge unknown">–ù–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ</span>
                            {% endif %}
                        </td>
                        <td>{{ report.created_at|date:"d.m.Y H:i" }}</td>
                        <td>
                            <a href="{% url 'research:report_detail' report.id %}" class="btn-view">
                                <i class="fas fa-eye"></i> –ü—Ä–æ—Å–º–æ—Ç—Ä
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="no-reports">
            <i class="fas fa-chart-bar"></i>
            <p>–ù–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏–∑–æ–≤. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø–µ—Ä–≤—ã–π –∞–Ω–∞–ª–∏–∑!</p>
        </div>
        {% endif %}
    </div>

    <!-- –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å -->
    <div class="theory-section">
        <h2><i class="fas fa-graduation-cap"></i> –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ—Å–Ω–æ–≤—ã</h2>
        
        <div class="theory-content">
            <div class="theory-card">
                <h3>–ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è</h3>
                <p>–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ–¥—Ö–æ–¥ <strong>–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</strong> –¥–ª—è –æ—Ü–µ–Ω–∫–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∞–ª–≥–æ—Ä–∏—Ç–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞–∫ —Ü–µ–ª–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏.</p>
                
                <div class="formula-display">
                    <h4>–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏:</h4>
                    \[
                    P_{\text{–î–¶}} = P\{(\hat{y}_1 \geq \hat{z}_1) \cap (\hat{y}_2 \geq \hat{z}_2) \cap (\hat{y}_3 \leq \hat{z}_3) \cap (\hat{y}_4 \leq \hat{z}_4) \cap (\hat{y}_5 \leq \hat{z}_5)\}
                    \]
                </div>
            </div>
            
            <div class="theory-card">
                <h3>–°—Ä–∞–≤–Ω–∏–≤–∞–µ–º—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã</h3>
                
                <div class="variants-comparison">
                    <div class="variant">
                        <h4>V1: –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å</h4>
                        <ul>
                            <li>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π</li>
                            <li>–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –º–æ—â–Ω–æ—Å—Ç–∏ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π</li>
                            <li>–ë–æ–ª–µ–µ –±—ã—Å—Ç—Ä–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞</li>
                        </ul>
                    </div>
                    
                    <div class="variant">
                        <h4>V2: –î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å</h4>
                        <ul>
                            <li>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π</li>
                            <li>–£—á—ë—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π</li>
                            <li>–ë–æ–ª–µ–µ —Ç–æ—á–Ω–æ–µ –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="theory-card">
                <h3>–ú–µ—Ç–æ–¥ –°–ò–ú (–°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –∏—Å–ø—ã—Ç–∞–Ω–∏–π)</h3>
                <p>–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–≤—É—Ö–∫–æ–Ω—Ç—É—Ä–Ω—ã–π –°–ò–ú:</p>
                <ol>
                    <li><strong>–í–Ω–µ—à–Ω–∏–π —Ü–∏–∫–ª</strong> (N‚ÇÅ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤): –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π</li>
                    <li><strong>–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ü–∏–∫–ª</strong> (N‚ÇÇ –ø—Ä–æ–≥–æ–Ω–æ–≤): –æ—Ü–µ–Ω–∫–∞ —É—Å–ª–æ–≤–Ω–æ–π –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏</li>
                </ol>
                
                <div class="formula-display">
                    <h4>–°—Ä–µ–¥–Ω—è—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å:</h4>
                    \[
                    \bar{P}_{\text{–î–¶}} = \frac{1}{N_1} \sum_{l=1}^{N_1} \hat{p}_l
                    \]
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ü–µ–Ω–∞—Ä–∏—è -->
<div id="scenarioModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è</h3>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="scenarioName">–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è:</label>
                <input type="text" id="scenarioName" class="form-control" 
                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ë–∞–∑–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π N1=100 N2=50">
            </div>
            
            <div class="form-group">
                <label>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –°–ò–ú:</label>
                <div class="param-row">
                    <div class="param">
                        <span class="param-label">N‚ÇÅ (—Å—Ü–µ–Ω–∞—Ä–∏–µ–≤):</span>
                        <span class="param-value">100</span>
                    </div>
                    <div class="param">
                        <span class="param-label">N‚ÇÇ (–ø—Ä–æ–≥–æ–Ω–æ–≤):</span>
                        <span class="param-value">50</span>
                    </div>
                    <div class="param">
                        <span class="param-label">L (–≥–∞—Ä–∞–Ω—Ç–∏—è):</span>
                        <span class="param-value">0.9</span>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label>–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è (–ø–æ—Ä–æ–≥–∏):</label>
                <div class="requirements-grid">
                    <div class="requirement">
                        <span class="req-label">·∫ë‚ÇÅ (–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å):</span>
                        <span class="req-value">‚â• 0.9</span>
                    </div>
                    <div class="requirement">
                        <span class="req-label">·∫ë‚ÇÇ (—Å—Ä–æ—á–Ω—ã–µ):</span>
                        <span class="req-value">‚â• 0.8</span>
                    </div>
                    <div class="requirement">
                        <span class="req-label">·∫ë‚ÇÉ (–ø–µ—Ä–µ–≥—Ä—É–∑):</span>
                        <span class="req-value">‚â§ 0.1</span>
                    </div>
                    <div class="requirement">
                        <span class="req-label">·∫ë‚ÇÑ (–ø–µ—Ä–µ—Ä–∞—Å—Ö–æ–¥):</span>
                        <span class="req-value">‚â§ 3.0</span>
                    </div>
                    <div class="requirement">
                        <span class="req-label">·∫ë‚ÇÖ (–∑–∞–¥–µ—Ä–∂–∫–∞):</span>
                        <span class="req-value">‚â§ 2.0</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary close-modal">–û—Ç–º–µ–Ω–∞</button>
            <button type="button" id="createScenarioBtn" class="btn btn-success">
                <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π
            </button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–≥—Ä—É–∑–∫–∏ -->
<div id="loadingModal" class="modal">
    <div class="modal-content">
        <div class="modal-body loading-modal">
            <div class="loading-spinner large"></div>
            <h3>–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–Ω–∞–ª–∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h3>
            <p>–ò–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–≤—É—Ö–∫–æ–Ω—Ç—É—Ä–Ω–æ–≥–æ –°–ò–ú. –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥...</p>
            <div class="loading-progress">
                <div class="progress-bar">
                    <div class="progress-fill"></div>
                </div>
                <div class="progress-text">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_script %}
<script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    const RUN_ANALYSIS_URL = "{% url 'research:run_analysis' %}";
    const CREATE_SCENARIO_URL = "{% url 'research:create_scenario' %}";
    const CSRF_TOKEN = "{{ csrf_token }}";
    
    $(document).ready(function() {
        // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
        $('#planSelect, #scenarioSelect').change(function() {
            const planSelected = $('#planSelect').val() !== '';
            const scenarioSelected = $('#scenarioSelect').val() !== '';
            $('#runAnalysisBtn').prop('disabled', !(planSelected && scenarioSelected));
        });
        
        // –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞
        $('#runAnalysisBtn').click(function() {
            const planId = $('#planSelect').val();
            const scenarioId = $('#scenarioSelect').val();
            
            if (!planId || !scenarioId) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞–Ω –∏ —Å—Ü–µ–Ω–∞—Ä–∏–π!');
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ –∑–∞–≥—Ä—É–∑–∫–∏
            $('#loadingModal').show();
            
            // –°–∏–º—É–ª–∏—Ä—É–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            simulateProgress();
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
            $.ajax({
                url: RUN_ANALYSIS_URL,
                method: 'POST',
                data: {
                    'plan_id': planId,
                    'scenario_id': scenarioId,
                    'csrfmiddlewaretoken': CSRF_TOKEN
                },
                success: function(response) {
                    if (response.success) {
                        // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ—Ç—á—ë—Ç–∞
                        window.location.href = response.redirect_url;
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + response.error);
                        $('#loadingModal').hide();
                    }
                },
                error: function() {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞');
                    $('#loadingModal').hide();
                }
            });
        });
        
        // –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è
        $('#createNewScenario').click(function(e) {
            e.preventDefault();
            $('#scenarioModal').show();
        });
        
        $('.close, .close-modal').click(function() {
            $(this).closest('.modal').hide();
        });
        
        $('#createScenarioBtn').click(function() {
            const name = $('#scenarioName').val().trim();
            
            if (!name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è');
                return;
            }
            
            $.ajax({
                url: CREATE_SCENARIO_URL,
                method: 'POST',
                data: {
                    'name': name,
                    'csrfmiddlewaretoken': CSRF_TOKEN
                },
                success: function(response) {
                    if (response.success) {
                        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –≤ select
                        const option = new Option(
                            response.name + ' (N1=100, N2=50)',
                            response.scenario_id
                        );
                        $('#scenarioSelect').append(option);
                        $('#scenarioSelect').val(response.scenario_id).trigger('change');
                        
                        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                        $('#scenarioModal').hide();
                        $('#scenarioName').val('');
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + response.error);
                    }
                }
            });
        });
        
        // –°–∏–º—É–ª—è—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        function simulateProgress() {
            const $progressFill = $('.progress-fill');
            const $progressText = $('.progress-text');
            const steps = [
                '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö...',
                '–ó–∞–ø—É—Å–∫ –°–ò–ú –¥–ª—è V1...',
                '–ó–∞–ø—É—Å–∫ –°–ò–ú –¥–ª—è V2...',
                '–†–∞—Å—á—ë—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π...',
                '–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á—ë—Ç–∞...'
            ];
            
            let step = 0;
            const interval = setInterval(function() {
                const progress = (step + 1) * 20;
                $progressFill.css('width', progress + '%');
                $progressText.text(steps[step]);
                
                step++;
                if (step >= steps.length) {
                    clearInterval(interval);
                }
            }, 800);
        }
    });
</script>
{% endblock %}