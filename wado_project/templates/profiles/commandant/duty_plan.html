{% extends "base_account.html" %}
{% load static %}
{% load dict_filters %}
{% load weekday_filters %}  {# ДОБАВЬТЕ ЭТУ СТРОКУ #}

{% block title %}План нарядов на {{ current_date|date:"F Y" }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/duty_plan.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
{% endblock %}

{% block account_content %}
<div class="duty-plan-container">
    <!-- Заголовок и навигация -->
    <div class="plan-header">
        <h1>План нарядов на <span class="month-highlight">{{ current_date|date:"F Y" }}</span></h1>
        
        <div class="month-navigation">
            <a href="?year={{ prev_month.year }}&month={{ prev_month.month }}" class="btn btn-secondary">
                <i class="fas fa-chevron-left"></i> {{ prev_month|date:"F Y" }}
            </a>
            <span class="current-month">{{ current_date|date:"F Y" }}</span>
            <a href="?year={{ next_month.year }}&month={{ next_month.month }}" class="btn btn-secondary">
                {{ next_month|date:"F Y" }} <i class="fas fa-chevron-right"></i>
            </a>
        </div>
    </div>

    <!-- Статус плана -->
    <div class="plan-status">
        {% if monthly_plan %}
            {% if monthly_plan.is_generated %}
                <div class="alert alert-success">
                    <div class="status-content">
                        <div>
                            <i class="fas fa-check-circle"></i>
                            <strong>График сгенерирован</strong>
                            {% if monthly_plan.last_generated_at %}
                                <span class="generation-date">
                                    ({{ monthly_plan.last_generated_at|date:"d.m.Y H:i" }})
                                </span>
                            {% endif %}
                        </div>
                        <form method="post" action="{% url 'commandant:reset_duty_plan' %}" class="reset-form">
                            {% csrf_token %}
                            <input type="hidden" name="year" value="{{ current_date.year }}">
                            <input type="hidden" name="month" value="{{ current_date.month }}">
                            <button type="submit" class="btn btn-danger btn-sm" 
                                    onclick="return confirm('Вы уверены, что хотите сбросить график? Все назначения будут удалены.')">
                                <i class="fas fa-trash"></i> Сбросить график
                            </button>
                        </form>
                    </div>
                </div>
            {% else %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    План создан, но график не сгенерирован
                </div>
            {% endif %}
        {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                План на <strong>{{ current_date|date:"F Y" }}</strong> еще не создан
            </div>
        {% endif %}
    </div>


    <!-- Панель управления -->
    <div class="control-panel">
        <div class="duty-selection">
            <h3>Настройка плана на <span class="month-highlight">{{ current_date|date:"F Y" }}</span></h3>
            
            <div class="plan-info">
                <p>Выберите наряды и настройте их расписание для генерации графика</p>
            </div>
            
            <div class="duty-list">
                {% for duty in duties %}
                <div class="duty-item" data-duty-id="{{ duty.id }}">
                    <div class="duty-info">
                        <input type="checkbox" name="selected_duties" value="{{ duty.id }}" 
                               id="duty_{{ duty.id }}" class="duty-checkbox"
                               {% if monthly_plan and duty in monthly_plan.duties.all %}checked{% endif %}>
                        <label for="duty_{{ duty.id }}" class="duty-label">
                            <strong>{{ duty.duty_name }}</strong>
                            <span class="duty-meta">({{ duty.people_count }} чел.)</span>
                            {% if duty.assigned_faculty %}
                                <span class="badge badge-fixed">Ф: {{ duty.assigned_faculty.name }}</span>
                            {% elif duty.assigned_department %}
                                <span class="badge badge-fixed">К: {{ duty.assigned_department.name }}</span>
                            {% endif %}
                        </label>
                    </div>
                    
                    <!-- Настройки расписания для наряда -->
                    <div class="schedule-settings">
                        {% with duty_schedule=duty_schedules|get_item:duty.id %}
                        <form method="post" class="schedule-form" data-duty-id="{{ duty.id }}">
                            {% csrf_token %}
                            <input type="hidden" name="duty_id" value="{{ duty.id }}">
                            
                            <!-- Визуальное отображение выбранных опций -->
                            <div class="selected-options">
                                <h4>Выбранные параметры:</h4>
                                <div class="options-tags" id="tags-{{ duty.id }}">
                                    {% with duty_schedule=duty_schedules|get_item:duty.id %}
                                        {% if duty_schedule.ranges or duty_schedule.specific_dates or duty_schedule.weekdays %}
                                            {% if duty_schedule.ranges %}
                                                {% for range in duty_schedule.ranges %}
                                                <span class="option-tag range-tag">
                                                    <i class="fas fa-calendar-day"></i>
                                                    {{ range }}
                                                    <button type="button" class="remove-tag" data-type="range" data-value="{{ range }}">&times;</button>
                                                </span>
                                                {% endfor %}
                                            {% endif %}
                                            
                                            {% if duty_schedule.specific_dates %}
                                                {% for date in duty_schedule.specific_dates %}
                                                <span class="option-tag date-tag">
                                                    <i class="fas fa-calendar-check"></i>
                                                    {{ date }}
                                                    <button type="button" class="remove-tag" data-type="date" data-value="{{ date }}">&times;</button>
                                                </span>
                                                {% endfor %}
                                            {% endif %}
                                            
                                            {% if duty_schedule.weekdays %}
                                                {% for weekday in duty_schedule.weekdays %}
                                                <span class="option-tag weekday-tag">
                                                    <i class="fas fa-calendar-week"></i>
                                                    {{ weekday|weekday_display }}
                                                    <button type="button" class="remove-tag" data-type="weekday" data-value="{{ weekday }}">&times;</button>
                                                </span>
                                                {% endfor %}
                                            {% endif %}
                                        {% else %}
                                            <span class="option-tag default-tag">
                                                <i class="fas fa-calendar-alt"></i>
                                                Весь месяц
                                                <span class="tag-hint">(по умолчанию)</span>
                                            </span>
                                        {% endif %}
                                    {% endwith %}
                                </div>
                            </div>

                            <!-- Форма добавления новых параметров -->
                            <div class="add-options">
                                <h4>Добавить параметры:</h4>
                                
                                <!-- Диапазон дат -->
                                <div class="option-group">
                                    <label>Диапазон дат:</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control range-input" 
                                               placeholder="Выберите диапазон дат" data-duty-id="{{ duty.id }}">
                                        <button type="button" class="btn btn-outline-primary add-range" data-duty-id="{{ duty.id }}">
                                            <i class="fas fa-plus"></i> Добавить
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Конкретные дни -->
                                <div class="option-group">
                                    <label>Конкретные дни:</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control dates-input" 
                                               placeholder="Выберите дни" data-duty-id="{{ duty.id }}">
                                        <button type="button" class="btn btn-outline-primary add-dates" data-duty-id="{{ duty.id }}">
                                            <i class="fas fa-plus"></i> Добавить
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Дни недели -->
                                <div class="option-group">
                                    <label>Дни недели:</label>
                                    <div class="weekdays-selector">
                                        {% for day_name in schedule_form.weekdays.field.choices %}
                                        <label class="weekday-checkbox">
                                            <input type="checkbox" value="{{ day_name.0 }}" data-duty-id="{{ duty.id }}">
                                            <span>{{ day_name.1 }}</span>
                                        </label>
                                        {% endfor %}
                                        <button type="button" class="btn btn-outline-primary add-weekdays" data-duty-id="{{ duty.id }}">
                                            <i class="fas fa-plus"></i> Добавить выбранные
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Скрытые поля для отправки -->
                            <div class="hidden-fields">
                                {% if duty_schedule.ranges %}
                                    {% for range in duty_schedule.ranges %}
                                    <input type="hidden" name="ranges[]" value="{{ range }}">
                                    {% endfor %}
                                {% endif %}
                                {% if duty_schedule.specific_dates %}
                                    {% for date in duty_schedule.specific_dates %}
                                    <input type="hidden" name="specific_dates[]" value="{{ date }}">
                                    {% endfor %}
                                {% endif %}
                                {% if duty_schedule.weekdays %}
                                    {% for weekday in duty_schedule.weekdays %}
                                    <input type="hidden" name="weekdays[]" value="{{ weekday }}">
                                    {% endfor %}
                                {% endif %}
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary clear-all" data-duty-id="{{ duty.id }}">
                                    <i class="fas fa-times"></i> Очистить все
                                </button>
                            </div>
                        </form>
                        {% endwith %}
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div class="generate-section">
                <button id="generate-plan-btn" class="btn btn-success btn-lg">
                    <i class="fas fa-cogs"></i> Сгенерировать график на {{ current_date|date:"F Y" }}
                </button>
                <p class="generate-hint">
                    Будет создан график распределения нарядов между подразделениями
                </p>
            </div>
        </div>
    </div>

    <!-- Статистика -->
    {% if unit_stats %}
    <div class="statistics-section">
        <h3>Статистика распределения</h3>
        <div class="stats-grid">
            {% for stat in unit_stats.values %}
            <div class="stat-card">
                <div class="stat-name">{{ stat.name }}</div>
                <div class="stat-count">{{ stat.count }} нарядов</div>
                <div class="stat-duties">
                    {% for duty in stat.duties %}
                    <span class="duty-tag">{{ duty }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Календарь с реальными данными -->
    <div class="calendar-section">
        <h3>График нарядов на {{ current_date|date:"F Y" }}</h3>
        
        {% if schedules %}
        <div class="calendar-grid">
            <div class="calendar-header">
                <div class="day-header">Пн</div>
                <div class="day-header">Вт</div>
                <div class="day-header">Ср</div>
                <div class="day-header">Чт</div>
                <div class="day-header">Пт</div>
                <div class="day-header">Сб</div>
                <div class="day-header">Вс</div>
            </div>
            
            {% for week in calendar_weeks %}
            <div class="calendar-week">
                {% for day_data in week %}
                <div class="calendar-day {% if not day_data.day %}empty{% endif %} {% if day_data.is_today %}today{% endif %}">
                    {% if day_data.day %}
                    <div class="day-number">{{ day_data.day }}</div>
                    <div class="day-schedules">
                        {% for schedule in day_data.schedules %}
                        <div class="duty-schedule {% if schedule.duty.assigned_faculty or schedule.duty.assigned_department %}fixed-duty{% endif %}">
                            <div class="duty-name">{{ schedule.duty.duty_name }}</div>
                            <div class="assigned-unit">
                                {% if schedule.assigned_faculty %}
                                    Ф: {{ schedule.assigned_faculty.name }}
                                {% elif schedule.assigned_department %}
                                    К: {{ schedule.assigned_department.name }}
                                {% else %}
                                    Не назначено
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-calendar">
            <p>График нарядов еще не сгенерирован</p>
            <p>Настройте наряды и нажмите "Сгенерировать график"</p>
        </div>
        {% endif %}
    </div>

    <!-- Таблица всех назначений -->
    {% if schedules %}
    <div class="schedules-table-section">
        <h3>Все назначенные наряды</h3>
        <div class="table-responsive">
            <table class="schedules-table">
                <thead>
                    <tr>
                        <th>Дата</th>
                        <th>Наряд</th>
                        <th>Подразделение</th>
                        <th>Статус</th>
                    </tr>
                </thead>
                <tbody>
                    {% for schedule in schedules %}
                    <tr>
                        <td>{{ schedule.date|date:"d.m.Y" }}</td>
                        <td>{{ schedule.duty.duty_name }}</td>
                        <td>
                            {% if schedule.assigned_faculty %}
                                Факультет: {{ schedule.assigned_faculty.name }}
                            {% elif schedule.assigned_department %}
                                Кафедра: {{ schedule.assigned_department.name }}
                            {% else %}
                                Не назначено
                            {% endif %}
                        </td>
                        <td>
                            {% if schedule.duty.assigned_faculty or schedule.duty.assigned_department %}
                                <span class="badge badge-fixed">Закреплен</span>
                            {% else %}
                                <span class="badge badge-rotating">Ротация</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_script %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
<script src="{% static 'js/duty_plan.js' %}"></script>
{% endblock %}