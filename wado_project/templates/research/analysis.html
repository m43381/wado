{% extends "base_account.html" %}
{% load static %}
{% load humanize %}
{% load dict_filters %}

{% block title %}–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/research.css' %}">
<style>
    /* –°—Ç–∏–ª—å –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏ */
    #loadingModal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.92);
        overflow: hidden;
    }
    
    #loadingModal .modal-content {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        color: white;
        margin: 5vh auto;
        padding: 25px;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        max-height: 85vh;
        box-shadow: 0 15px 35px rgba(0,0,0,0.6);
        border: 1px solid rgba(255,255,255,0.15);
        animation: modalAppear 0.4s ease-out;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    
    @keyframes modalAppear {
        from {
            opacity: 0;
            transform: translateY(-20px) scale(0.98);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }
    
    .loading-modal {
        text-align: center;
        display: flex;
        flex-direction: column;
        height: 100%;
        overflow: hidden;
    }
    
    .loading-modal h3 {
        color: #4fc3f7;
        margin-bottom: 8px;
        font-size: 1.6rem;
        line-height: 1.3;
    }
    
    .loading-modal p {
        color: #bbbbbb;
        margin-bottom: 20px;
        font-size: 1rem;
        line-height: 1.4;
    }
    
    .loading-spinner.large {
        width: 70px;
        height: 70px;
        border: 5px solid rgba(79, 195, 247, 0.2);
        border-top: 5px solid #4fc3f7;
        border-radius: 50%;
        animation: spin 1.3s linear infinite;
        margin: 0 auto 20px;
        box-shadow: 0 0 25px rgba(79, 195, 247, 0.4);
        flex-shrink: 0;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .progress-container {
        margin-top: 15px;
        background: rgba(0,0,0,0.25);
        padding: 15px;
        border-radius: 8px;
        border: 1px solid rgba(255,255,255,0.1);
        flex-shrink: 0;
    }
    
    .progress-bar {
        height: 14px;
        background: rgba(255,255,255,0.08);
        border-radius: 7px;
        overflow: hidden;
        margin-bottom: 12px;
        position: relative;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #00c853, #64dd17, #aeea00);
        width: 0%;
        transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        box-shadow: 0 0 8px rgba(100, 221, 23, 0.5);
    }
    
    .progress-fill::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, 
            transparent 0%, 
            rgba(255,255,255,0.5) 50%, 
            transparent 100%);
        animation: shimmer 1.8s infinite;
    }
    
    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }
    
    .progress-text {
        font-size: 16px;
        font-weight: 600;
        color: #4fc3f7;
        margin-bottom: 8px;
        min-height: 24px;
        text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        line-height: 1.3;
    }
    
    .progress-percentage {
        font-size: 14px;
        color: #aeea00;
        font-weight: 500;
        margin-top: 5px;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π —Å–∏–º—É–ª—è—Ü–∏–∏ */
    .simulation-details {
        margin-top: 15px;
        border-top: 1px solid rgba(255,255,255,0.1);
        padding-top: 15px;
        flex: 1;
        min-height: 0;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .simulation-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 15px;
        flex-shrink: 0;
    }
    
    .stat-item {
        background: rgba(52, 152, 219, 0.12);
        padding: 10px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        gap: 8px;
        border: 1px solid rgba(52, 152, 219, 0.2);
        transition: all 0.2s ease;
        min-height: 50px;
    }
    
    .stat-item:hover {
        background: rgba(52, 152, 219, 0.18);
    }
    
    .stat-item i {
        color: #3498db;
        font-size: 1.1em;
        width: 20px;
        text-align: center;
        flex-shrink: 0;
    }
    
    .stat-label {
        font-weight: 500;
        color: #aaa;
        font-size: 0.8rem;
        line-height: 1.2;
        flex: 1;
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .stat-value {
        font-weight: bold;
        color: white;
        font-size: 0.9rem;
        text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        flex-shrink: 0;
        margin-left: 5px;
        text-align: right;
        min-width: 60px;
    }
    
    .simulation-info {
        background: rgba(0,0,0,0.25);
        border-radius: 6px;
        padding: 12px;
        flex: 1;
        min-height: 0;
        overflow-y: auto;
        border: 1px solid rgba(255,255,255,0.08);
        box-shadow: inset 0 1px 5px rgba(0,0,0,0.3);
    }
    
    .simulation-info::-webkit-scrollbar {
        width: 4px;
    }
    
    .simulation-info::-webkit-scrollbar-track {
        background: rgba(0,0,0,0.2);
        border-radius: 2px;
    }
    
    .simulation-info::-webkit-scrollbar-thumb {
        background: #4fc3f7;
        border-radius: 2px;
    }
    
    .info-item {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        padding: 6px 0;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        animation: fadeIn 0.3s ease-out;
        font-size: 0.85rem;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(5px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .info-item:last-child {
        border-bottom: none;
    }
    
    .info-item i {
        color: #27ae60;
        font-size: 0.9em;
        width: 16px;
        text-align: center;
        flex-shrink: 0;
        margin-top: 2px;
    }
    
    .info-item span {
        color: #e0e0e0;
        line-height: 1.4;
        flex: 1;
        word-break: break-word;
    }
    
    /* –ê–Ω–∏–º–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ */
    .pulse-text {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-height: 700px) {
        #loadingModal .modal-content {
            margin: 3vh auto;
            padding: 20px;
            max-height: 94vh;
        }
        
        .loading-spinner.large {
            width: 60px;
            height: 60px;
            margin-bottom: 15px;
        }
        
        .loading-modal h3 {
            font-size: 1.4rem;
            margin-bottom: 5px;
        }
        
        .loading-modal p {
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        
        .simulation-stats {
            grid-template-columns: 1fr;
            gap: 8px;
        }
        
        .stat-item {
            padding: 8px;
            min-height: 45px;
        }
        
        .simulation-info {
            max-height: 150px;
        }
    }
    
    @media (max-width: 480px) {
        #loadingModal .modal-content {
            width: 95%;
            padding: 20px;
        }
        
        .simulation-stats {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block account_content %}
<div class="research-container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="research-header">
        <h1>üéØ –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞—Ä—è–¥–æ–≤</h1>
        <p class="research-subtitle">–ê–Ω–∞–ª–∏–∑ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –º–µ—Ç–æ–¥–æ–≤ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</p>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å –±—ã—Å—Ç—Ä–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ -->
    <div class="research-quick-panel">
        <h2><i class="fas fa-rocket"></i> –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞</h2>
        
        <div class="quick-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="planSelect">
                        <i class="fas fa-calendar-alt"></i> –í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞–Ω:
                    </label>
                    <select id="planSelect" class="form-control">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞–Ω --</option>
                        {% for plan in monthly_plans %}
                        <option value="{{ plan.id }}" 
                                data-month="{{ plan.month|date:'F Y' }}"
                                data-duties="{{ plan.duties.count }}">
                            {{ plan.month|date:"F Y" }} ({{ plan.duties.count }} –Ω–∞—Ä—è–¥–æ–≤)
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="scenarioSelect">
                        <i class="fas fa-cogs"></i> –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ü–µ–Ω–∞—Ä–∏–π:
                    </label>
                    <select id="scenarioSelect" class="form-control">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ü–µ–Ω–∞—Ä–∏–π --</option>
                        {% for scenario in scenarios %}
                        <option value="{{ scenario.id }}">
                            {{ scenario.name }} (N1={{ scenario.n1_scenarios }}, N2={{ scenario.n2_runs }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="quick-actions">
                <button id="runAnalysisBtn" class="btn btn-success" disabled>
                    <i class="fas fa-play"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                </button>
                <div class="quick-info">
                    <p><i class="fas fa-info-circle"></i> –ë—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –¥–≤—É—Ö–∫–æ–Ω—Ç—É—Ä–Ω—ã–π –°–ò–ú –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ V1 –∏ V2</p>
                </div>
            </div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="research-stats">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number" id="statTotalReports">{{ total_reports }}</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –æ—Ç—á—ë—Ç–æ–≤</div>
                </div>
            </div>
            
            
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">{{ monthly_plans|length }}</div>
                    <div class="stat-label">–î–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-scroll"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">{{ scenarios|length }}</div>
                    <div class="stat-label">–°—Ü–µ–Ω–∞—Ä–∏–µ–≤</div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ù–µ–¥–∞–≤–Ω–∏–µ –æ—Ç—á—ë—Ç—ã -->
    <div class="recent-reports-section">
        <h2><i class="fas fa-history"></i> –ù–µ–¥–∞–≤–Ω–∏–µ –æ—Ç—á—ë—Ç—ã</h2>
        
        {% if recent_reports %}
        <div class="reports-table-wrapper">
            <div class="reports-table">
                <table>
                    <thead>
                        <tr>
                            <th>–ü–ª–∞–Ω</th>
                            <th>–°—Ü–µ–Ω–∞—Ä–∏–π</th>
                            <th>PÃÑ–¥—Ü V1</th>
                            <th>PÃÑ–¥—Ü V2</th>
                            <th>–õ—É—á—à–∏–π</th>
                            <th>–î–∞—Ç–∞</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for report in recent_reports %}
                        <tr>
                            <td title="{{ report.plan.month|date:'F Y' }}">
                                <div class="table-cell-content">
                                    {{ report.plan.month|date:"M Y" }}
                                </div>
                            </td>
                            
                            <td title="{{ report.scenario.name }}">
                                <div class="table-cell-content">
                                    {{ report.scenario.name|truncatechars:20 }}
                                </div>
                            </td>
                            
                            <td>
                                <span class="probability-badge {% if report.p_dc_v1_mean >= 0.8 %}good{% elif report.p_dc_v1_mean >= 0.6 %}medium{% else %}poor{% endif %}">
                                    {{ report.p_dc_v1_mean|floatformat:3 }}
                                </span>
                            </td>
                            
                            <td>
                                <span class="probability-badge {% if report.p_dc_v2_mean >= 0.8 %}good{% elif report.p_dc_v2_mean >= 0.6 %}medium{% else %}poor{% endif %}">
                                    {{ report.p_dc_v2_mean|floatformat:3 }}
                                </span>
                            </td>
                            
                            <td>
                                {% if report.get_better_variant == 'V1' %}
                                <span class="variant-badge v1" title="V1 (–∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å)">V1</span>
                                {% elif report.get_better_variant == 'V2' %}
                                <span class="variant-badge v2" title="V2 (–¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å)">V2</span>
                                {% else %}
                                <span class="variant-badge unknown">-</span>
                                {% endif %}
                            </td>
                            
                            <td title="{{ report.created_at|date:'d.m.Y H:i:s' }}">
                                <div class="table-cell-content">
                                    {{ report.created_at|date:"d.m.Y H:i" }}
                                </div>
                            </td>
                            
                            <td>
                                <div class="action-buttons">
                                    <a href="{% url 'research:report_detail' report.id %}" 
                                    class="btn-view" 
                                    title="–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç—á—ë—Ç">
                                        <i class="fas fa-eye"></i>
                                        <span>–ü—Ä–æ—Å–º–æ—Ç—Ä</span>
                                    </a>
                                    <button class="btn-delete delete-report-btn" 
                                            data-report-id="{{ report.id }}" 
                                            data-report-name="{{ report.plan.month|date:'F Y' }} - {{ report.scenario.name }}"
                                            title="–£–¥–∞–ª–∏—Ç—å –æ—Ç—á—ë—Ç">
                                        <i class="fas fa-trash"></i>
                                        <span>–£–¥–∞–ª–∏—Ç—å</span>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% else %}
        <div class="no-reports">
            <i class="fas fa-chart-bar"></i>
            <p>–ù–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏–∑–æ–≤. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø–µ—Ä–≤—ã–π –∞–Ω–∞–ª–∏–∑!</p>
        </div>
        {% endif %}
    </div>

    <!-- –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å -->
    <div class="theory-section">
        <h2><i class="fas fa-graduation-cap"></i> –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ—Å–Ω–æ–≤—ã</h2>
        
        <div class="theory-content">
            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ 1: –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è -->
            <div class="theory-card">
                <h3><i class="fas fa-cogs"></i> –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è</h3>
                <p>–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ–¥—Ö–æ–¥ <strong>–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</strong> –¥–ª—è –æ—Ü–µ–Ω–∫–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∞–ª–≥–æ—Ä–∏—Ç–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞–∫ —Ü–µ–ª–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏.</p>
                
                <div class="formula-display">
                    <h4><i class="fas fa-square-root-alt"></i> –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏:</h4>
                    \[
                    P_{\text{–î–¶}} = P\{(\hat{y}_1 \geq \hat{z}_1) \cap (\hat{y}_2 \geq \hat{z}_2) \cap (\hat{y}_3 \leq \hat{z}_3) \cap (\hat{y}_4 \leq \hat{z}_4) \cap (\hat{y}_5 \leq \hat{z}_5)\}
                    \]
                </div>
                
                <div class="explanation">
                    <p><strong>–ì–¥–µ:</strong></p>
                    <ul>
                        <li>≈∑‚ÇÅ - –¥–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π</li>
                        <li>≈∑‚ÇÇ - –¥–æ–ª—è —Å—Ä–æ—á–Ω—ã—Ö –Ω–∞—Ä—è–¥–æ–≤ –≤ —Å—Ä–æ–∫</li>
                        <li>≈∑‚ÇÉ - –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –ø–µ—Ä–µ–≥—Ä—É–∑–∞ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π</li>
                        <li>≈∑‚ÇÑ - –ø–µ—Ä–µ—Ä–∞—Å—Ö–æ–¥ —Ä–µ—Å—É—Ä—Å–∞ (—Å–≤–µ—Ä—Ö—É—Ä–æ—á–Ω—ã–µ)</li>
                        <li>≈∑‚ÇÖ - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</li>
                    </ul>
                </div>
            </div>
            
            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ 2: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ -->
            <div class="theory-card">
                <h3><i class="fas fa-balance-scale"></i> –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã</h3>
                <p>–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–≤–æ–¥–∏—Ç—Å—è –¥–ª—è –¥–≤—É—Ö –º–æ–¥–µ–ª–µ–π –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–∞:</p>
                
                <div class="variants-comparison">
                    <div class="variant">
                        <h4><i class="fas fa-layer-group"></i> V1: –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å</h4>
                        <ul>
                            <li>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π</li>
                            <li>–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –º–æ—â–Ω–æ—Å—Ç–∏ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π</li>
                            <li>–ë–æ–ª–µ–µ –±—ã—Å—Ç—Ä–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞</li>
                            <li>–ú–µ–Ω—å—à–∞—è –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å</li>
                            <li>–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –∫—Ä—É–ø–Ω—ã—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π</li>
                        </ul>
                    </div>
                    
                    <div class="variant">
                        <h4><i class="fas fa-user-friends"></i> V2: –î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å</h4>
                        <ul>
                            <li>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π</li>
                            <li>–£—á—ë—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π</li>
                            <li>–ë–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è</li>
                            <li>–£—á—ë—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫</li>
                            <li>–í—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è</li>
                        </ul>
                    </div>
                </div>
                
                <div class="comparison-note">
                    <p><i class="fas fa-info-circle"></i> <strong>–¶–µ–ª—å —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:</strong> –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –∫–∞–∫–∞—è –º–æ–¥–µ–ª—å –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±–æ–ª–µ–µ –≤—ã—Å–æ–∫—É—é –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏ –ø—Ä–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–≥—Ä—É–∑–∫–∏ -->
<div id="loadingModal">
    <div class="modal-content">
        <div class="modal-body loading-modal">
            <div class="loading-spinner large"></div>
            <h3>üöÄ –ó–∞–ø—É—Å–∫ –¥–≤—É—Ö–∫–æ–Ω—Ç—É—Ä–Ω–æ–≥–æ –°–ò–ú</h3>
            <p class="pulse-text">–ò–¥—ë—Ç –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞—Ä—è–¥–æ–≤...</p>
            
            <div class="progress-container">
                <div class="progress-text">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –°–ò–ú-–¥–≤–∏–∂–∫–∞...</div>
                <div class="progress-bar">
                    <div class="progress-fill"></div>
                </div>
                <div class="progress-percentage">0%</div>
            </div>
            
            <!-- –î–µ—Ç–∞–ª–∏ —Å–∏–º—É–ª—è—Ü–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_script %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            displayMath: [['$$', '$$'], ['\\[', '\\]']],
            processEscapes: true,
            processEnvironments: true
        },
        options: {
            skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
            ignoreHtmlClass: 'tex2jax_ignore',
            processHtmlClass: 'tex2jax_process'
        }
    };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<script>
    // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
    const RUN_ANALYSIS_URL = "{% url 'research:run_analysis' %}";
    const DELETE_REPORT_URL = "{% url 'research:delete_report' %}";
    const GET_STATISTICS_URL = "{% url 'research:get_statistics' %}";
    const CSRF_TOKEN = "{{ csrf_token }}";
    
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let simulationInterval = null;
    let isSimulationRunning = false;
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function showAlert(message, type) {
        const alertClass = type === 'success' ? 'alert-success' : 
                          type === 'warning' ? 'alert-warning' : 'alert-danger';
        const icon = type === 'success' ? 'fa-check-circle' :
                     type === 'warning' ? 'fa-exclamation-triangle' : 'fa-times-circle';
        
        const alert = $('<div class="alert ' + alertClass + ' alert-dismissible fade show">' +
                      '<div class="d-flex align-items-center">' +
                      '<i class="fas ' + icon + ' me-3"></i>' +
                      '<div class="flex-grow-1">' + message + '</div>' +
                      '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                      '</div>' +
                      '</div>');
        
        $('.research-container').prepend(alert);
        
        setTimeout(function() {
            alert.alert('close');
        }, 5000);
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç—á—ë—Ç–∞
    function deleteReport(reportId, reportName) {
        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –æ—Ç—á—ë—Ç:\n"${reportName}"?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) {
            return;
        }
        
        const originalButton = $(`.btn-delete[data-report-id="${reportId}"]`);
        const originalHtml = originalButton.html();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        originalButton.html('<i class="fas fa-spinner fa-spin"></i> –£–¥–∞–ª–µ–Ω–∏–µ...').prop('disabled', true);
        
        $.ajax({
            url: DELETE_REPORT_URL,
            method: 'POST',
            data: {
                'report_id': reportId,
                'csrfmiddlewaretoken': CSRF_TOKEN
            },
            success: function(response) {
                if (response.success) {
                    // –ù–∞—Ö–æ–¥–∏–º —Å—Ç—Ä–æ–∫—É —Ç–∞–±–ª–∏—Ü—ã –∏ —É–¥–∞–ª—è–µ–º –µ—ë —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
                    const $row = originalButton.closest('tr');
                    $row.fadeOut(400, function() {
                        $(this).remove();
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                        updateStatistics();
                        showAlert('–û—Ç—á—ë—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω', 'success');
                        
                        // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫ –±–æ–ª—å—à–µ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                        if ($('.reports-table tbody tr').length === 0) {
                            $('.reports-table-wrapper').hide();
                            $('.no-reports').show();
                        }
                    });
                } else {
                    showAlert('–û—à–∏–±–∫–∞: ' + response.error, 'danger');
                    originalButton.html(originalHtml).prop('disabled', false);
                }
            },
            error: function(xhr, status, error) {
                showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ—Ç—á—ë—Ç–∞', 'danger');
                originalButton.html(originalHtml).prop('disabled', false);
            }
        });
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    function updateStatistics() {
        $.ajax({
            url: GET_STATISTICS_URL,
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    $('#statTotalReports').text(response.total_reports);
                    $('#statTotalSimulations').text(response.total_simulations.toLocaleString());
                }
            },
            error: function(xhr, status, error) {
                console.error('Error updating statistics:', error);
            }
        });
    }
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –∑–∞–ø—É—Å–∫–∞ –∞–Ω–∞–ª–∏–∑–∞
    function validateForm() {
        const planSelect = $('#planSelect');
        const scenarioSelect = $('#scenarioSelect');
        const runBtn = $('#runAnalysisBtn');
        
        const planSelected = planSelect.val() !== '';
        const scenarioSelected = scenarioSelect.val() !== '';
        const isValid = planSelected && scenarioSelected;
        
        runBtn.prop('disabled', !isValid);
        return isValid;
    }
    
    // –ó—Ä–µ–ª–∏—â–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è —Å–∏–º—É–ª—è—Ü–∏–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π (10 —Å–µ–∫—É–Ω–¥)
    function startSimulationAnimation() {
        if (isSimulationRunning) return;
        isSimulationRunning = true;
        
        const $modal = $('#loadingModal');
        const $progressFill = $('.progress-fill');
        const $progressText = $('.progress-text');
        const $progressPercentage = $('.progress-percentage');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        $modal.css('display', 'block');
        
        // –î–æ–±–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –¥–µ—Ç–∞–ª–µ–π —Å–∏–º—É–ª—è—Ü–∏–∏, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
        if (!$modal.find('.simulation-details').length) {
            $modal.find('.progress-container').after(`
                <div class="simulation-details">
                    <div class="simulation-stats">
                        <div class="stat-item">
                            <i class="fas fa-microchip"></i>
                            <span class="stat-label">–¢–µ–∫—É—â–∏–π —à–∞–≥:</span>
                            <span class="stat-value" id="currentStep">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-redo"></i>
                            <span class="stat-label">–ò—Ç–µ—Ä–∞—Ü–∏—è:</span>
                            <span class="stat-value" id="currentIteration">0/0</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-clock"></i>
                            <span class="stat-label">–ü—Ä–æ—à–ª–æ:</span>
                            <span class="stat-value" id="elapsedTime">0:00</span>
                        </div>
                    </div>
                    <div class="simulation-info" id="simulationInfo">
                        <div class="info-item">
                            <i class="fas fa-cogs"></i>
                            <span>–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–≤—É—Ö–∫–æ–Ω—Ç—É—Ä–Ω–æ–≥–æ –°–ò–ú...</span>
                        </div>
                    </div>
                </div>
            `);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç—ã
        const $currentStepEl = $('#currentStep');
        const $currentIterationEl = $('#currentIteration');
        const $speedEl = $('#speed');
        const $elapsedTimeEl = $('#elapsedTime');
        const $simulationInfoEl = $('#simulationInfo');
        
        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        $simulationInfoEl.empty();
        
        // –≠—Ç–∞–ø—ã —Å–∏–º—É–ª—è—Ü–∏–∏ - –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–´ –î–û 10 –°–ï–ö–£–ù–î
        const simulationSteps = [
            { text: '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –°–ò–ú...', progress: 10, info: '–ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è', iterations: '1/8', duration: 800 },
            { text: '–ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–∞–Ω–∞...', progress: 20, info: '–ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –Ω–∞—Ä—è–¥–∞—Ö', iterations: '2/8', duration: 700 },
            { text: '–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–¥–µ–ª–∏ V1...', progress: 30, info: '–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏', iterations: '3/8', duration: 900 },
            { text: '–ó–∞–ø—É—Å–∫ –°–ò–ú –¥–ª—è V1...', progress: 45, info: '–ú–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–Ω–µ—à–Ω–µ–≥–æ –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Ü–∏–∫–ª–æ–≤', iterations: '4/8', duration: 1500 },
            { text: '–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–¥–µ–ª–∏ V2...', progress: 55, info: '–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏', iterations: '5/8', duration: 800 },
            { text: '–ó–∞–ø—É—Å–∫ –°–ò–ú –¥–ª—è V2...', progress: 70, info: '–ú–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–º–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏', iterations: '6/8', duration: 1600 },
            { text: '–°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑...', progress: 85, info: '–†–∞—Å—á—ë—Ç –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–π –∏ —Ç–µ—Å—Ç–æ–≤', iterations: '7/8', duration: 1400 },
            { text: '–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á—ë—Ç–∞...', progress: 95, info: '–°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∏ –≤—ã–≤–æ–¥–æ–≤', iterations: '8/8', duration: 1200 },
            { text: '–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ...', progress: 100, info: '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤', iterations: '8/8', duration: 500 }
        ];
        
        let currentStep = 0;
        let startTime = Date.now();
        let lastUpdateTime = startTime;
        let totalSimulations = 0;
        let simulationsPerSecond = 0;
        
        // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        function addInfoMessage(message, icon = 'fa-cogs') {
            const messageEl = $(`
                <div class="info-item">
                    <i class="fas ${icon}"></i>
                    <span>${message}</span>
                </div>
            `);
            
            $simulationInfoEl.prepend(messageEl);
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
            if ($simulationInfoEl.children().length > 6) {
                $simulationInfoEl.children().last().remove();
            }
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–æ–≤–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
            $simulationInfoEl.scrollTop(0);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateStats() {
            const now = Date.now();
            const elapsedSeconds = Math.floor((now - startTime) / 1000);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å
            if (now - lastUpdateTime >= 1000) {
                simulationsPerSecond = Math.floor(Math.random() * 120) + 60;
                totalSimulations += simulationsPerSecond;
                lastUpdateTime = now;
            }
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è
            const minutes = Math.floor(elapsedSeconds / 60);
            const seconds = elapsedSeconds % 60;
            const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            if (currentStep < simulationSteps.length) {
                $currentStepEl.text(simulationSteps[currentStep].text);
                $currentIterationEl.text(simulationSteps[currentStep].iterations);
            }
            $speedEl.text(`${formatNumber(simulationsPerSecond)}/—Å–µ–∫`);
            $elapsedTimeEl.text(timeString);
        }
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–ª–∞
        function formatNumber(num) {
            if (num >= 1000) return `${(num/1000).toFixed(1)}k`;
            return num;
        }
        
        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        function updateProgress() {
            if (currentStep < simulationSteps.length) {
                const step = simulationSteps[currentStep];
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                $progressText.text(step.text);
                $progressFill.css('width', step.progress + '%');
                $progressPercentage.text(`${step.progress}%`);
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                addInfoMessage(step.info, getIconForStep(currentStep));
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                updateStats();
                
                // –°–ª—É—á–∞–π–Ω–æ–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —à–∞–≥–æ–≤)
                if (currentStep >= 3 && currentStep <= 6 && Math.random() > 0.7) {
                    setTimeout(() => {
                        const messages = [
                            '–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è...',
                            '–†–∞—Å—á—ë—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏...',
                            '–ê–Ω–∞–ª–∏–∑ –ø–µ—Ä–µ–≥—Ä—É–∑–∞...',
                            '–û—Ü–µ–Ω–∫–∞ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏...',
                            '–ú–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π...'
                        ];
                        addInfoMessage(messages[Math.floor(Math.random() * messages.length)], 'fa-calculator');
                    }, step.duration / 2);
                }
                
                currentStep++;
                
                // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
                if (currentStep < simulationSteps.length) {
                    setTimeout(updateProgress, step.duration);
                } else {
                    // –ü–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–≥
                    setTimeout(() => {
                        $progressText.text('‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω!');
                        addInfoMessage('–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ—Ç—á—ë—Ç–∞...', 'fa-check-circle');
                        updateStats();
                    }, 500);
                }
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∫–æ–Ω–∫–∏ –¥–ª—è —à–∞–≥–∞
        function getIconForStep(stepIndex) {
            const icons = ['fa-cogs', 'fa-database', 'fa-layer-group', 'fa-microchip', 
                          'fa-user-friends', 'fa-microchip', 'fa-chart-line', 
                          'fa-file-alt', 'fa-check-circle'];
            return icons[stepIndex] || 'fa-cogs';
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
        updateProgress();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
        simulationInterval = setInterval(updateStats, 1000);
    }
    
    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–∏
    function stopSimulationAnimation() {
        if (simulationInterval) {
            clearInterval(simulationInterval);
            simulationInterval = null;
        }
        isSimulationRunning = false;
        $('#loadingModal').css('display', 'none');
    }
    
    $(document).ready(function() {
        console.log('Research page loaded');
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –∑–∞–ø—É—Å–∫–∞ –∞–Ω–∞–ª–∏–∑–∞
        validateForm();
        $('#planSelect, #scenarioSelect').on('change', validateForm);
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è –æ—Ç—á—ë—Ç–æ–≤
        $(document).on('click', '.btn-delete', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const $button = $(this);
            const reportId = $button.data('report-id');
            const reportName = $button.data('report-name');
            
            if (reportId && reportName) {
                deleteReport(reportId, reportName);
            } else {
                showAlert('–û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –æ—Ç—á—ë—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'danger');
            }
        });
        
        // –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞
        $('#runAnalysisBtn').click(function(e) {
            e.preventDefault();
            
            if ($(this).prop('disabled')) {
                showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞–Ω –∏ —Å—Ü–µ–Ω–∞—Ä–∏–π –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –∞–Ω–∞–ª–∏–∑–∞!', 'warning');
                return;
            }
            
            const planId = $('#planSelect').val();
            const scenarioId = $('#scenarioSelect').val();
            
            if (!planId || !scenarioId) {
                showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞–Ω –∏ —Å—Ü–µ–Ω–∞—Ä–∏–π!', 'warning');
                return;
            }
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            const $button = $(this);
            const originalHtml = $button.html();
            $button.html('<i class="fas fa-spinner fa-spin"></i> –ó–∞–ø—É—Å–∫...').prop('disabled', true);
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —Å–∏–º—É–ª—è—Ü–∏–∏
            startSimulationAnimation();
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            $.ajax({
                url: RUN_ANALYSIS_URL,
                method: 'POST',
                data: {
                    'plan_id': planId,
                    'scenario_id': scenarioId,
                    'csrfmiddlewaretoken': CSRF_TOKEN
                },
                success: function(response) {
                    if (response.success) {
                        // –î–∞—ë–º –∞–Ω–∏–º–∞—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è (10 —Å–µ–∫—É–Ω–¥), –∑–∞—Ç–µ–º –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º
                        setTimeout(function() {
                            stopSimulationAnimation();
                            $button.html(originalHtml).prop('disabled', false);
                            window.location.href = response.redirect_url;
                        }, 10000); // 10 —Å–µ–∫—É–Ω–¥ –Ω–∞ –≤—Å—é –∞–Ω–∏–º–∞—Ü–∏—é
                    } else {
                        stopSimulationAnimation();
                        $button.html(originalHtml).prop('disabled', false);
                        showAlert('–û—à–∏–±–∫–∞: ' + response.error, 'danger');
                    }
                },
                error: function(xhr, status, error) {
                    stopSimulationAnimation();
                    $button.html(originalHtml).prop('disabled', false);
                    showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞: ' + error, 'danger');
                }
            });
        });
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        setTimeout(function() {
            $('.research-header, .research-quick-panel, .stats-grid, .theory-section, .recent-reports-section')
                .each(function(i) {
                    const $el = $(this);
                    setTimeout(function() {
                        $el.css({
                            'transition': 'all 0.6s ease',
                            'opacity': '1',
                            'transform': 'translateY(0)'
                        });
                    }, 100 + (i * 150));
                });
        }, 300);
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        $(window).click(function(e) {
            if ($(e.target).attr('id') === 'loadingModal') {
                stopSimulationAnimation();
            }
        });
        
        // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        $(document).on('hidden.bs.modal', '#loadingModal', function() {
            $('#runAnalysisBtn').html('<i class="fas fa-play"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏').prop('disabled', false);
        });
    });
</script>
{% endblock %}